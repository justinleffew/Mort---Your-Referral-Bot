## Codebase Patterns
- (Add only durable, reusable patterns here. Not story-specific notes.)

---

## 2026-01-28 00:00 - INIT
- Initialized progress log.
- Files changed: progress.txt
- Learnings for future iterations:
  - Keep this file append-only.
---
## 2026-01-28 18:31 - US-001
- What was implemented
  - Parse explicit interest cues from contact notes and normalize/merge into radar_interests on note creation.
- Files changed
  - services/dataService.ts
  - prd.json
- Assumptions made (if any)
  - Interpreted explicit interest cues as phrases like "interests/hobbies/likes/enjoys/into/interested in" within notes and normalized them to lowercase keywords.
  - Treated the current HEAD as the base for the required branch because no main branch exists in this repo.
- Tests / checks run (and results)
  - npm run build (pass)
  - Skipped lint/typecheck/tests (no scripts in package.json).
- Learnings for future iterations:
  - Patterns discovered
    - dataService.addNote is the centralized place to augment notes with derived contact metadata.
  - Gotchas
    - None observed.
---
## 2026-01-28 19:27 - US-002
- What was implemented
  - Switched frontend edge function helper to use Supabase functions.invoke and updated OpenAI/TTS calls to new function names.
- Files changed
  - services/edgeFunctions.ts
  - services/openaiService.ts
  - services/dataService.ts
- Assumptions made (if any)
  - Interpreted this change as supporting US-002 without completing all acceptance criteria; PRD status left unchanged per instructions.
  - Supabase functions.invoke will attach auth headers automatically when a session exists, as required.
- Tests / checks run (and results)
  - npx tsc --noEmit (fails: existing type errors in App.tsx, services/dataService.ts, services/supabaseClient.ts, supabase/functions/*)
  - npm run build (pass)
  - Skipped lint/tests (no scripts in package.json).
- Learnings for future iterations:
  - Patterns discovered
    - Edge function calls are centralized via services/edgeFunctions.ts.
  - Gotchas
    - Repo typecheck currently fails due to unrelated TS errors and Deno edge function types.
---
## 2026-01-29 02:56 - US-002
- What was implemented
  - Added an authenticated news search edge function backed by GDELT, plus a client helper to fetch interest + location matches.
  - Enriched interest-based radar prompts with a recent event context when available.
  - Documented the Realtor radar flow and cadence guidance.
- Files changed
  - supabase/functions/mort-news-search/index.ts
  - services/newsService.ts
  - services/openaiService.ts
  - types.ts
  - App.tsx
  - services/dataService.ts
  - tsconfig.json
  - env.d.ts
  - docs/realtor-radar-flow.md
  - prd.json
- Assumptions made (if any)
  - GDELT's public doc API is acceptable as an API-based news source and returns `articles` with `title`, `url`, `seendate`, and `domain` fields.
  - A 30-day timespan and date-sorted results are sufficiently deterministic for the same interest/location input.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
- Learnings for future iterations:
  - Patterns discovered
    - Event enrichment can be injected into radar prompts without altering UI flows.
  - Gotchas
    - None observed.
---
## 2026-01-29 03:48 - US-003
- What was implemented
  - Removed import-contacts UI and CSV/Google modal from radar and contacts screens.
  - Collapsed copy-ready scripts into a modal launched from a single button.
  - Removed the calculator route/nav entry and simplified Mort chat to just the input/response flow.
- Files changed
  - App.tsx
  - components/MortgageAssist.tsx
- Assumptions made (if any)
  - Interpreted the request to remove CSV/Google imports as removing the UI entry points while keeping the underlying bulk import helper intact.
  - Removed the standalone calculator screen and navigation entry without touching mortgage chat behavior.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
- Learnings for future iterations:
  - Patterns discovered
    - None.
  - Gotchas
    - Playwright screenshot attempt failed due to a Chromium crash in the container.
---
## 2026-01-29 04:09 - US-003
- What was implemented
  - Added fallback "Why now" reasoning to avoid error text for friendly check-ins and other radar angles.
  - Removed pulsing animation from the radar loading card and lightened the placeholder styling.
- Files changed
  - services/openaiService.ts
  - components/RadarCard.tsx
- Assumptions made (if any)
  - Interpreted the "Why now" error as missing/failed AI reasoning and provided deterministic fallbacks per radar angle.
  - Interpreted the "blinking contact" as the radar card loading skeleton pulse.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
  - Skipped lint/tests (no scripts in package.json)
- Learnings for future iterations:
  - Patterns discovered
    - Provide deterministic fallback strings for AI-derived UI fields to avoid "Error" placeholders.
  - Gotchas
    - None observed.
---
## 2026-01-29 05:30 - ADHOC-VOICE-CONTACTS
- What was implemented
  - Fixed brain dump and follow-up AI calls to target the mort-openai/mort-openai-tts edge functions, updated follow-up prompting, and softened fallback copy to be conversational.
  - Added silence-based auto-stop for Commute Mode recordings, removed the manual finalize button, and defaulted voice playback to Nova.
  - Hardened brain dump contact creation by parsing valid years before writing sale dates.
- Files changed
  - services/openaiService.ts
  - components/CommuteMode.tsx
  - services/dataService.ts
- Assumptions made (if any)
  - The correct edge function names for OpenAI and TTS are mort-openai and mort-openai-tts based on the Supabase function directory.
  - Brain dump sale dates should only be stored when a valid 4-digit year is present to avoid insert errors.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
- Learnings for future iterations:
  - Patterns discovered
    - Commute Mode uses speech transcript changes to trigger conversational follow-ups, so silence-based recording stops should feed that same pipeline.
  - Gotchas
    - None observed.
---
## 2026-01-29 04:45 - ADHOC-CORS-EDGE-FUNCTIONS
- What was implemented
  - Added per-function CORS helpers with origin allowlists, preflight handling, and minimal request logging for mort-openai and mort-openai-tts.
- Files changed
  - supabase/functions/mort-openai/index.ts
  - supabase/functions/mort-openai-tts/index.ts
- Assumptions made (if any)
  - Treated "localhost" as any http(s) origin whose hostname is exactly localhost and "*.vercel.app" as any origin whose hostname ends with .vercel.app.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
- Learnings for future iterations:
  - Patterns discovered
    - None.
  - Gotchas
    - None observed.
---
## 2026-01-29 04:56 - ADHOC-CORS-EDGE-FUNCTIONS
- What was implemented
  - Removed product-specific CORS origin checks and limited the CORS allowlist to localhost and *.vercel.app origins in mort-openai and mort-openai-tts.
- Files changed
  - supabase/functions/mort-openai/index.ts
  - supabase/functions/mort-openai-tts/index.ts
- Assumptions made (if any)
  - Assumed Mort only needs localhost and Vercel preview/production origins for browser access at this time.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
- Learnings for future iterations:
  - Patterns discovered
    - None.
  - Gotchas
    - None observed.
---
## 2026-01-29 16:23 - ADHOC-UI-ACCESSIBILITY
- What was implemented
  - Added light-mode theme tokens via CSS variables and Tailwind colors, raised base font size, and updated the app shell to use semantic colors.
  - Replaced user-facing schema terms through a central UI_LABELS mapping, refreshed navigation labels, added a dashboard voice FAB and header Add action, and moved sign out into Settings.
  - Made Daily Actions focus cards fully clickable, added an active referrals empty-state CTA with an inline referral modal, and elevated script output with copy actions.
- Files changed
  - App.tsx
  - components/RadarCard.tsx
  - components/MortgageAssist.tsx
  - components/CommuteMode.tsx
  - components/AuthPanel.tsx
  - index.css
  - tailwind.config.cjs
  - utils/uiLabels.ts
- Assumptions made (if any)
  - Treated the Daily Actions referral modal as the direct Add Referral flow for the empty-state CTA.
  - Used system prefers-color-scheme for optional dark mode instead of adding a user toggle.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
- Learnings for future iterations:
  - Patterns discovered
    - Centralized UI_LABELS is the safest way to swap user-facing schema labels.
  - Gotchas
    - Screenshot capture is limited without an authenticated Supabase session.
---
## 2026-01-29 17:49 - ADHOC-CONTACTS-CLEANUP
- What was implemented
  - Removed the Contacts screen Segment and Tags filters, keeping only the functional Next touch and Sort controls.
  - Removed the MORT wordmark text from the app header and auth header, leaving the icon-only branding.
- Files changed
  - App.tsx
- Assumptions made (if any)
  - Treated the request as an ad-hoc UI cleanup not mapped to an existing PRD story, so prd.json remains unchanged.
  - Removed the header wordmark in both authenticated and auth layouts to keep branding consistent.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
  - Skipped lint/tests (no scripts in package.json).
- Learnings for future iterations:
  - Patterns discovered
    - None.
  - Gotchas
    - None observed.
---
## 2026-01-29 18:44 - ADHOC-API-FIX
- What was implemented
  - Updated edge function CORS handling and logging across mort-openai, mort-openai-tts, mort-run-now, and mort-news-search.
  - Added referral_events/touches RLS migration and improved client-side error surfacing for save flows.
- Files changed
  - supabase/functions/_shared/cors.ts
  - supabase/functions/mort-openai/index.ts
  - supabase/functions/mort-openai-tts/index.ts
  - supabase/functions/mort-run-now/index.ts
  - supabase/functions/mort-news-search/index.ts
  - services/dataService.ts
  - App.tsx
  - components/RadarCard.tsx
  - components/CommuteMode.tsx
  - supabase/migrations/20250311120000_referral_events_and_touch_policies.sql
- Assumptions made (if any)
  - Created the required branch from the current HEAD because no main branch exists locally.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
  - Skipped lint/tests (no scripts in package.json)
- Learnings for future iterations:
  - Patterns discovered
    - None.
  - Gotchas
    - None.
---
## 2026-01-29 18:56 - ADHOC-REMOVE-HEYDAD
- What was implemented
  - Removed Hey Dad branding references from CORS allowlists and historical progress notes.
- Files changed
  - supabase/functions/_shared/cors.ts
  - progress.txt
- Assumptions made (if any)
  - None.
- Tests / checks run (and results)
  - npx tsc --noEmit (pass)
  - npm run build (pass)
  - Skipped lint/tests (no scripts in package.json)
- Learnings for future iterations:
  - Patterns discovered
    - None.
  - Gotchas
    - None.
---
